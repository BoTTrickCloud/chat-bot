<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport"
	      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>BoTTrick ChatBot</title>

	<!--<link rel="stylesheet" href="./assets/css/bootstrap.min.css">-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
	<link rel="stylesheet" href="./assets/css/style.css">

	<script src="assets/js/jquery-3.3.1.min.js"></script>
</head>
<body>

	<div id="chatbot">
		<div class="chat-icon">
			<img src="./assets/img/bottrick.jpg" alt="logo">
		</div>
		<div class="chat-window">
			<header class="header">
				<div class="avatar-image">
					<img src="./assets/img/bottrick.jpg" alt="logo">
				</div>
				<div>
					<h2 class="name">ChatBot</h2>
					<small>Online</small>
				</div>
				<div class="close">
					<i class="fas fa-times"></i>
				</div>
			</header>
			<section class="messages">

			</section>
			<footer class="footer">
				<input type="text" name="message" placeholder="Pošlite správu..." disabled>
				<button id="send-message">
					<i class="fas fa-paper-plane"></i>
				</button>
			</footer>
		</div>
	</div>

	<script>
		$(document).ready(function() {
			let index = 0;
			let chatBot = $('#chatbot');
			let chatBotWindow = chatBot.find('.chat-window');
			let sendMessage = chatBot.find('#send-message');
			let messages = chatBot.find('.messages');
			let messageInput = sendMessage.parent().find('input');
			let aboutMe = $('<div>').addClass('message buttons choice').append(
			    $('<a>').attr('href', '#').attr('data-action', 'about_me').html('About Me')
			);
			// Only for DEMO
			chatBotWindow.toggle();

			chatBot.find('.chat-icon').click(function() {
				chatBotWindow.toggle();
				if (index === 0) {
					buildMessage('Hi there! How can I help you?', 'ChatBot', 'author');
					messages.append(aboutMe);
					messageInput.prop('disabled', false);
				}
				// Scroll down on new message
				messages.scrollTop(messages[0].scrollHeight);
			});

			chatBot.find('.close').click(function() {
				chatBotWindow.toggle();
			});

			// On send message
			sendMessage.click(function() {
				// Skip if empty message
				if (messageInput.val() === '') return;

				buildMessage(messageInput.val(), 'User', 'customer');

				// Send data
				sendData(messageInput.val(), false);
				// Clear input value
				messageInput.val('');
				// Scroll down on new message
				messages.scrollTop(messages[0].scrollHeight);
			});

			messageInput.on('keyup', function(e) {
				if (e.keyCode === 13) {
					e.preventDefault();
					sendMessage.click();
				}
			});


			// On button click
			$(document).on('click', '#chatbot .messages .message.buttons:not(.first-choice) a', function(e) {
				e.preventDefault();

				// Send data
				sendData($(this).data('action'), true);
				// Clear input value
				messageInput.val('');
				// Scroll down on new message
				messages.scrollTop(messages[0].scrollHeight);

			});

			function buildMessage(msg, name, type, avatar) {
				if (typeof avatar === "undefined")
					avatar = 'https://greendestinations.org/wp-content/uploads/2019/05/avatar-exemple.jpg';
				if (type === 'author')
					avatar = './assets/img/bottrick.jpg';

				// Build message
				let message = $('<div>').addClass('message-content').html(msg);
				let fullMessage = $('<div>').addClass('message').data('index', index).addClass(type).data('type', type).append(
					$('<div>').addClass('avatar').append(
						$('<div>').addClass('avatar-image').append(
							$('<img>').attr('src', avatar)
						),
						$('<span>').html(name)
					),
					$('<div>').addClass('message-content-wrapper').append(
						message,
						$('<div class="divider">')
					)
				);

				let lasttMessage = $('.message:last');
				if (lasttMessage.data('type') === type) {
					lasttMessage.find('.message-content-wrapper').append(
						message,
						$('<div class="divider">')
					);
				} else {
					messages.append(fullMessage);
				}
				index++;

			}

			function buildButtons(buttons) {
				let type = 'choice';
				let fullMessage = $('<div>').addClass('message').data('index', index).addClass('buttons').addClass(type).data('type', type);
				$.each(buttons, function(i, item) {
					fullMessage.append($('<a>').attr('href', '#').attr('data-action', item.action).html(item.value));
				});
				fullMessage.insertAfter(messages.find('.message.author:last'))

			}

			function sendData(data, action) {
				$.ajax({
					method: "POST",
					dataType: "json",
                    contentType: "application/json",
					// url: "http://localhost:5000/bot",
					url: "http://localhost:8080/bot",
					data: JSON.stringify({
						question: data,
						action: action,
						language: "sk"
					}),
					success: function (resp) {
						try {
							let obj = JSON.parse(JSON.stringify(resp));
							buildMessage(obj.response, 'ChatBot', 'author');
							if (obj.actions.length > 1) {
							    buildButtons(obj.actions);
							}
							// Scroll down on new message
							messages.scrollTop(messages[0].scrollHeight);
						} catch (e) {
							console.log("Error: ", e);
						}
					}
				});
			}
		});
	</script>
</body>
</html>
